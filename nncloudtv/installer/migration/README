=============================================================================================================
things to add for zooatomics.jsp
=============================================================================================================
<%@ page language="java" contentType="text/html; charset=UTF-8" pageEncoding="UTF-8"%>

soundManager.url = '/player/';  
(from soundManager.url = '/javascripts/player/';)

=============================================================================================================
DB Migration
=============================================================================================================
================================
build up python environment
================================
> python --version
Python 2.6.5
> apt-get install python-mysqldb

================================
build up GAE python environment
================================
- download google_appengine_1.6.2.zip
> wget http://googleappengine.googlecode.com/files/google_appengine_1.6.3.zip

- unzip, move to /home/ubuntu/google_appengine
> unzip google_appengine_1.6.3.zip

- python files put under /home/ubuntu/google_appengine folder 

================================
copy gae backup files over
================================
- get backup files from amazon 
apt-get install s3cmd
<<<<<<<<<<<<<<<<<< change date >>>>>>>>>>>>>>>>>>>>>
ubuntu> s3cmd ls s3://9x9gaedata/20120430_150501_9x9tvprod3*
ubuntu> 
<<<<<<<<<<<<<<<<<< change date >>>>>>>>>>>>>>>>>>>>>
s3cmd get s3://9x9gaedata/20120430_150501_9x9tvprod3_A*
s3cmd get s3://9x9gaedata/20120430_150501_9x9tvprod3_C*
s3cmd get s3://9x9gaedata/20120430_150501_9x9tvprod3_I*
s3cmd get s3://9x9gaedata/20120430_150501_9x9tvprod3_M*
s3cmd get s3://9x9gaedata/20120430_150501_9x9tvprod3_N*
s3cmd get s3://9x9gaedata/20120430_150501_9x9tvprod3_S*

- remove unnecessary files and decompress
rm *.log.*
bzip2 -d *	
mv filename, remove date_9x9tvprod3

-  alter table
mysql -h localhost -u root -p
use nncloudtv_content;
alter table mso add column ori_id bigint(20);
create index mso_ori_id on mso (ori_id);
alter table nnset add column ori_id bigint(20);
alter table nnchannel add column ori_id bigint(20);
create index nnchannel_backup_ori_id on nnchannel_backup(ori_id);
alter table category add column ori_id bigint(20);
alter table nnprogram add column ori_id bigint(20);
create index content_ownership_content_id on content_ownership (contentId);
create index content_ownership_mso_id on content_ownership (msoId);
create index sns_mso_id on sns_auth (msoId);

create index nnprogram_channel_id on nnprogram(channelId);

use nncloudtv_nnuser1;
alter table nnuser add column ori_id bigint(20);
create index nnuser_backup_ori_id on nnuser_backup (ori_id);
create index nnuser_backup_id on nnuser_backup (id);
create index nnuser_watched_channel_id on nnuser_watched (channelId);
create index nnuser_watched_user_id on nnuser_watched (userId);
create index nnuser_subscribe_channel_id on nnuser_subscribe (channelId);
create index nnuser_subscribe_user_id on nnuser_subscribe (userId);
create index nnuser_share_channel_id on nnuser_share (channelId);
create index nnuser_share_user_id on nnuser_share (userId);
create index nnuser_share_program_id on nnuser_share (programId);
create index nnuser_pref_user_id on nnuser_pref (userId);
create index nnuser_backup_user_id on nnuser_backup (id);
create index nnchannel_autosharing_channel_id on nnchannel_autosharing(channelId);
create index nnchannel_autosharing_mso_id on nnchannel_autosharing(msoId);

- run python migration files 
cd /home/ubuntu/googleappengine
python mso.py
python mso_config.py
python captcha.py
python category.py
python content_ownership.py
python nnset.py
python nnchannel.py
python nnprogram.py
python category_nnset.py
python nnset_nnchannel.py
python category_nnset_modify.py
python nnset_nnchannel_modify.py
python nnprogram_modify.py
python nnuser.py
python nnuser_pref.py
python nnuser_sorting.py
python nnuser_share.py
python nnuser_watched.py
python nnuser_report.py
python nnuser_subscribe.py
python nnuser_subscribe_group.py
python nncontent.py 
python nnchannel_autosharing.py
python nnset_autosharing.py
python sns_auth.py

- data backup
use nncloudtv_content;
create table mso_backup select * from mso; 
create table nnset_backup select * from nnset;
create table nnchannel_backup select * from nnchannel;
create table nnprogram_backup select * from nnprogram;
create table category_backup select * from category;

use nncloudtv_nnuser1;
create table nnuser_backup select * from nnuser;
create table nnuser_subscribe_backup select * from nnuser_subscribe;
create table nnuser_pref_backup select * from nnuser_pref;
create table nnuser_channel_sorting_backup select * from nnuser_channel_sorting;

- data modify
use nncloudtv_content;
update nnchannel set imageUrl='http://s3.amazonaws.com/9x9ui/war/v0/images/facebook-icon.gif' where imageUrl='/WEB-INF/../images/facebook-icon.gif';
update nnchannel set imageUrl='http://s3.amazonaws.com/9x9ui/war/v0/images/processing.png' where imageUrl='/WEB-INF/../images/processing.png';
update nnprogram set imageUrl='http://s3.amazonaws.com/9x9ui/war/v0/images/cms/radio.jpg' where imageUrl='/images/cms/radio.jpg';

update content_ownership o, nnchannel_backup c set o.contentId = c.id where o.contentType = 2 and o.contentId = c.ori_id; 
update content_ownership o, nnset_backup s set o.contentId = s.id where o.contentType = 1 and o.contentId = s.ori_id;
update content_ownership o, mso_backup m set o.msoId = m.id where o.msoId = m.ori_id;
update content_ownership o, nnset s set o.contentId = s.id where o.contentType = 1 and o.contentId = s.ori_id;
update sns_auth s, mso_backup m set s.msoId = m.id where s.msoId = m.ori_id;
update nnchannel_autosharing a, nnchannel_backup c set a.channelId = c.id where a.channelId = c.ori_id;
update nnchannel_autosharing a, mso_backup m set a.msoId= m.id where a.msoId= m.ori_id; 

use nncloudtv_nnuser1;
update nnuser u set u.msoId = (select id from nncloudtv_content.mso_backup m where u.msoId = m.ori_id);
update nnuser u set u.msoId = (select msoId from nnuser_backup b where u.id=b.id);
 
(update nnuser set token=concat('1-', token);)
update nnuser set shard=1;
update nnuser_pref p set p.userId = (select id from nnuser u where p.userId = u.ori_id);
delete from nnuser_pref where userId=0;
update nnuser_channel_sorting s set s.userId = (select id from nnuser u where s.userId = u.ori_id);
update nnuser_channel_sorting s set s.channelId = (select id from nncloudtv_content.nnchannel c where s.channelId = c.ori_id);

update nnuser_share s set s.userId = (select id from nnuser u where s.userId = u.ori_id);
delete from nnuser_share where userId=0;
update nnuser_share s set s.channelId = (select id from nncloudtv_content.nnchannel c where s.channelId = c.ori_id);
update nnuser_share s set s.programId = (select id from nncloudtv_content.nnprogram p where s.programId = p.ori_id) where s.programId != 0;
update nnuser_share s set s.setId = (select id from nncloudtv_content.nnset s where s.setId = s.ori_id) where s.setId != 0;
update nnuser_watched w set w.userId = (select id from nnuser u where w.userId = u.ori_id);
delete from nnuser_watched where userId=0;
update nnuser_watched w set w.channelId = (select id from nncloudtv_content.nnchannel c where w.channelId = c.ori_id);

update nnuser_subscribe s set s.userId = (select id from nnuser_backup u where s.userId = u.ori_id);
delete from nnuser_watched where userId=0;
update nnuser_subscribe s, nncloudtv_content.nnchannel_backup c set s.channelId = c.id where s.channelId = c.ori_id;

update nnuser_subscribe_group s set s.userId = (select id from nnuser_backup u where s.userId = u.ori_id);
update nnuser_subscribe_group s, nncloudtv_content.nnchannel_backup c set s.channelId = c.id where s.channelId = c.ori_id;

- alter back
use nncloudtv_content;
alter table mso drop column ori_id;
alter table nnset drop column ori_id;
alter table nnchannel drop column ori_id;
alter table category drop column ori_id;
alter table nnprogram drop column ori_id;

use nncloudtv_nnuser1;	
alter table nnuser drop column ori_id;	

use nncloudtv_nnuser2;	
alter table nnuser drop column ori_id;	

