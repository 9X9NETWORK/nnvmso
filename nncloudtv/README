About this document,

Two sections,
- Devel environment and tool: more for Windows
- EC2: i.e. Ubuntu on EC2

=============================================================================================================
Devel environment and tool
=============================================================================================================
================================
First time setup procedures
================================
Detail for each step can be found in the following sections.

- Download JDK 1.6.0, MySql 5.5.10, RabbitMQ 1.8, Maven 3.0.3 
Details can be found in the following sections
  
- Start MySql server

- Start RabbitMQ server

- Create databases and tables
Reference MySql file

- Modify datanucleus.properties files, 
there are four, this is to make sure your db connection is setup correctly

- Run nnqueue client 
Reference README in nnqueue project

- Run memcache server 

- datanucleus jdo enhance:
Go to project root folder, 
> mvn datanucleus:enhance (it might not be necessary)

- Run nncloudtv on Jetty: 
Go to project root folder, 
> mvn jetty:run

- Basic tests,
http://localhost:8888/hello/world (test your servlet and spring dispatcher)
http://localhost:8888/hello/pdr (write a db record)
http://localhost:8888/hello/cache_set (test memcache component)
http://localhost:8888/fanout?exchange_name=hello (test rabbitq, nnqueue should output a hello message)

- ready to go,
go to http://localhost:8888/admin/index, click on initialize link

================================
mvn 
================================
- Download 3.0.3
http://maven.apache.org/download.html 

- read pom.xml
================================
Datanucleus tool
================================
datanucleus commands:

- enhance
mvn datanucleus:enhance

- Schema tool
mvn datanucleus:schema-create

Note: 
1. You might run into command length limitation error if running on Windows. Remove everything under java except model folder if it's the case.
2. Currently there is four databases need to be initiated. Depending on the db you are going to initiate, change configuration in datanucleus plugin section in pom.xml before you run schema-create
3. Alternatively, reference MySql file

================================
Jetty
================================
- Run your application on jetty
1) go to project root folder, 
2) mvn jetty:run

================================
RabbitMQ
================================
- Windows download
http://www.rabbitmq.com/releases/bundles/v1.7.2/

- installation quick guide 
> unzip the package
> install erlang 5.7.4 using otp_win32_R13B03.exe
> set ERLANG_HOME in environment variable
> (move folder rabbitmq-server-windows-1.7.2 to program files)

- commands examples: 
> cd C:\Program Files (x86)\RabbitMQ\rabbitmq_server-1.7.2\sbin
> double click "rabbitmq-server.bat" to start the server
> rabbitmqctl list_exchanges 
> rabbitmqctl list_queues

================================
MySql
================================
- Download MySQL Server 5.5

- commands on Windows: 
> cd c:\Program Files\MySQL\MySQL Server 5.5\bin
> mysqld
> mysql nncloudtv_analytics -h localhost -u root -p
> mysql nncloudtv_content -h localhost -u root -p
> mysql nncloudtv_nnuser1 -h localhost -u root -p
> mysql nncloudtv_nnuser2 -h localhost -u root -p

- dump data example
> mysqldump --user=root nncloudtv_analytics > nnanalytics.sql

- import data example
> cat nnanalytics.sql | mysql nncloudtv_analytics -h localhost -u root -p

- please reference MySql file
 
================================
Package
================================
- packaging nncloudtv war procedures:
  a) modify datanucleus.properties files, there are four.
  b) packaging:   
     mvn datanucleus:enhance 
     mvn war:war
  c) test the packaged war with jetty plugin:    
     mvn jetty:deploy-war
     packaging and run jetty with jetty plugin: 
     mvn jetty:run-war 

- packaging nnqueue jar:
  reference nnqueue.README 

================================
In the pipeline
================================ 
- YouTube lib rewrite, the original lib is not maven friendly. replace with com.google.api.client lib
- Admin portal
- CMS portal
- NnUser, find by email, look up the 2nd partition if 1st lookup fails, and update user partition
- Put memcache back 

================================
Note
================================
- javascript and image resources should only be placed on amazon s3.
use account nncloudtv@gmail.com to access


=============================================================================================================
EC2
=============================================================================================================
================================
Jetty 
================================
- installation
> apt-get install jetty
> apt-get install libjetty-extra
> apt-get install openjdk-6-jdk

- configuration
> modify /etc/default/jetty
> change value of "NO_START" to "NO_START=0" 
> change value of "JETTY_HOST" TO "JETTY_HOST=0.0.0.0"

- start/stop jetty
> service jetty start
> service jetty stop

- jetty version
> cd /usr/share/jetty 
> java -jar start.jar --version
null 6.1.22

- deploy app: deploy your wars to webapps under jetty 
> /usr/share/jetty/webapps

================================
MySql
================================
- installation 
apt-get install mysql-server-5.1

- commands
> service mysql start

================================
RabbitMQ
================================
- installation
> apt-cache search rabbitmq
> apt-get install rabbitmq-server

- commands: 
rabbitmqctl status

================================
Memcached
================================
> apt-get install memcached

================================
Running the app on EC2
================================  
- upload the war and the jar: use SCP with your private key, and upload to the server

- login name: ubuntu

- commands: 
sudo su
cd /usr/share/jetty/webapps
service jetty stop
rm root.war
mv /home/ubuntu/tmp/nncloudtv-0.0.1-SNAPSHOT.war .
mv nncloudtv-0.0.1-SNAPSHOT.war root.war
service jetty start
java -jar nnqueue.jar hello
java -jar nnqueue.jar brand_counter
java -jar nnqueue.jar category_create
java -jar nnqueue.jar channel_create_related

- testing on java02, 
wget http://localhost:8080/hello/world (local test)
http://ec2-174-129-141-179.compute-1.amazonaws.com:8080/hello/world (basic web server test)
http://ec2-174-129-141-179.compute-1.amazonaws.com:8080/hello/pdr (write to db test)
http://ec2-174-129-141-179.compute-1.amazonaws.com:8080/hello/cache_set (test memcache component)
http://ec2-174-129-141-179.compute-1.amazonaws.com:8080/hello/cache_get (test memcache component)
http://ec2-174-129-141-179.compute-1.amazonaws.com:8080/hello/fanout?exchange_name=hello (rabbit queue client test)

- run on port 80 
sudo /sbin/iptables -t nat -I PREROUTING -p tcp --dport 80 -j REDIRECT --to-port 8080

- stop apache2 (if u ever need it)
> sudo /etc/init.d/apache2 stop

